<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<!-- namespace에는 xml파일과 연결할 Mapper interface 파일명을 패키지를 포함하여 적어주세요 -->
<mapper namespace="com.green.backend_shop.cart.mapper.CartMapper">
   <resultMap id="cart" type="com.green.backend_shop.cart.dto.CartDTO">
       <id     column="CART_NUM"        property="cartNum" />
       <result column="BOOK_NUM"        property="bookNum" />
       <result column="CART_CNT"        property="cartCnt" />
       <result column="MEM_ID"          property="memId" />
       <result column="TOTAL_PRICE"     property="totalPrice" />
       <result column="CART_DATE"       property="cartDate" />
       <association property="bookDTO"  resultMap="com.green.backend_shop.book.mapper.BookMapper.book" />
   </resultMap>

    <!--장바구니 목록 조회-->
    <select id="getCartList" resultMap="cart">
        SELECT CART_NUM
            , CART_CNT
            , TOTAL_PRICE
            , CART_DATE
            , TITLE
            , PRICE
            , C.BOOK_NUM
        FROM shop_cart C INNER JOIN book B
        ON C.BOOK_NUM = B.BOOK_NUM
        WHERE MEM_ID = #{memId}
        ORDER BY CART_DATE DESC
    </select>

    <insert id="addCart">
        INSERT INTO shop_cart (
            BOOK_NUM
            , CART_CNT
            , MEM_ID
            , TOTAL_PRICE
        ) VALUES (
            #{bookNum}
            , #{cartCnt}
            , #{memId}
            , (SELECT PRICE
                FROM book
                WHERE BOOK_NUM = #{bookNum}) * #{cartCnt}
        )
    </insert>

    <!--장바구니에 등록하려는 상품이 현재 등록되어 있는지 확인-->
    <select id="getCartNum" resultType="String">
        SELECT MEM_ID
        FROM shop_cart
        WHERE BOOK_NUM = #{bookNum}
        AND MEM_ID = #{memId}
    </select>

    <!--장바구니 수량 변경-->
    <update id="updateCartCnt">
        UPDATE shop_cart
        SET
            CART_CNT = CART_CNT + #{cartCnt}
            , TOTAL_PRICE = (SELECT PRICE
                            FROM book
                            WHERE BOOK_NUM = #{bookNum}) * CART_CNT
        WHERE MEM_ID = #{memId}
        AND BOOK_NUM = #{bookNum}
    </update>




</mapper>































