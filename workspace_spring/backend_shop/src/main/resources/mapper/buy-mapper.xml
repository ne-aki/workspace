<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<!-- namespace에는 xml파일과 연결할 Mapper interface 파일명을 패키지를 포함하여 적어주세요 -->
<mapper namespace="com.green.backend_shop.buy.mapper.BuyMapper">
	<resultMap id="buy" type="com.green.backend_shop.buy.dto.BuyDTO">
    <id column="BUY_NUM" property="buyNum" />
    <result column="BOOK_NUM" property="bookNum" />
    <result column="MEM_ID" property="memId" />
    <result column="BUY_DATE" property="buyDate" />
    <result column="BUY_CNT" property="buyCnt" />
    <result column="ORDER_NUM" property="orderNum" />
    <result column="TOTAL_PRICE" property="totalPrice" />
    <association property="bookDTO" resultMap="com.green.backend_shop.book.mapper.BookMapper.book" />
  </resultMap>

  <resultMap id="buyDTOForAdmin" type="com.green.backend_shop.buy.dto.BuyDTOForAdmin">
    <id column="ORDER_NUM" property="orderNum" />
    <result column="MEM_ID" property="memId" />
    <result column="PRICE" property="price" />
    <result column="BUY_DATE" property="buyDate" />
    <result column="TITLE" property="title" />
  </resultMap>
  <!--도서 상세 페이지 - 구매하기 -->
  <insert id="insertBuy">
    INSERT INTO SHOP_BUY (
      BOOK_NUM
      , MEM_ID
      , BUY_CNT
      , ORDER_NUM
    ) VALUES (
      #{bookNum}
      , #{memId}
      , #{buyCnt}
      , (SELECT IFNULL(MAX(ORDER_NUM), 0) + 1 FROM SHOP_BUY)
    )
  </insert>
  <!--장바구니 페이지 - 구매하기-->
  <insert id="buyAll">
    INSERT INTO shop_buy (BOOK_NUM, MEM_ID, BUY_CNT, ORDER_NUM)
    VALUES
    <foreach collection="cartNumList" item="cartNum" separator=",">
      (
        (SELECT BOOK_NUM FROM shop_cart WHERE CART_NUM = #{cartNum})
        , #{memId}
        , (SELECT CART_CNT FROM shop_cart WHERE CART_NUM = #{cartNum})
        , (SELECT IFNULL(MAX(ORDER_NUM), 0) + 1 FROM SHOP_BUY)
      )
    </foreach>
  </insert>

  <!--관리자 페이지 - 구매 이력 조회-->
  <select id="getBuyListForAdmin" resultMap="buyDTOForAdmin">
    SELECT
      ORDER_NUM
      , MAX(MEM_ID) MEM_ID
      , SUM((
          SELECT PRICE
          FROM book
          WHERE BOOK_NUM = shop_buy.BOOK_NUM
        ) * BUY_CNT) PRICE
      , MAX(BUY_DATE) BUY_DATE
      , CASE COUNT(ORDER_NUM) - 1
    WHEN 0 THEN MAX((
      SELECT TITLE
      FROM BOOK
      WHERE BOOK_NUM = shop_buy.BOOK_NUM
    ))
    ELSE CONCAT(MAX((
    SELECT TITLE
    FROM BOOK
    WHERE BOOK_NUM = shop_buy.BOOK_NUM
    ))
      , ' 외 '
      , COUNT(ORDER_NUM) - 1
      , '건'
    )
    END TITLE
    FROM shop_buy
    WHERE 1 = 1
    <!--
      if태그 안에 들어가는 test는 쌍따옴표 넣으면 짝이 이상하게 잡힐 수 있기 때문에 홀따옴표를 주로 쓴다.
      또 test 안의 문법은 getter를 호출하기 때문에 자바 문법처럼 쓴다.
    -->
    <if test='orderNum != null and !orderNum.equals("")'>
      AND order_num = #{orderNum}
    </if>
    <if test='memId != null and !memId.equals("")'>
      AND MEM_ID LIKE CONCAT('%', #{memId}, '%')
    </if>
    <if test='fromDate != null and !fromDate.equals("")'>
      AND BUY_DATE &gt;= #{fromDate}
    </if>
    <if test='toDate != null and !toDate.equals("")'>
      AND BUY_DATE &lt;= #{toDate}
    </if>
    GROUP BY ORDER_NUM
    ORDER BY BUY_DATE DESC
  </select>
  <!--구매 내역 상세 조회-->
  <select id="getBuyDetail" resultMap="buy">
    SELECT
    BUY_NUM
      , BUY_CNT
      , TITLE
      , PRICE
      , PRICE * BUY_CNT AS TOTAL_PRICE
      , ATTACHED_IMG_NAME
    FROM shop_buy S
    INNER JOIN book B
    ON S.BOOK_NUM = B.BOOK_NUM
    INNER JOIN book_img I
    ON I.BOOK_NUM = S.BOOK_NUM
    WHERE IS_MAIN = 'Y'
    AND ORDER_NUM = #{orderNum}
  </select>
</mapper>































